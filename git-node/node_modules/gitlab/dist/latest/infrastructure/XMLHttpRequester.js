"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _errors = require("request-promise-core/errors");

var _util = _interopRequireDefault(require("util.promisify"));

var _xhr = _interopRequireDefault(require("xhr"));

var _RequestHelper = _interopRequireDefault(require("./RequestHelper"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function promisifyFn(fn) {
  const promisifiedFn = (0, _util.default)(fn);
  return async function getResponse(opts) {
    const response = await promisifiedFn(opts);
    const sleepTime = parseInt(response.headers['retry-after'], 10);

    if (response.statusCode === 429 && sleepTime) {
      await (0, _RequestHelper.default)(sleepTime * 1000);
    } else if (response.statusCode >= 400 && response.statusCode <= 599) {
      throw new _errors.StatusCodeError(response.statusCode, response.body, {}, null);
    }

    return opts.resolveWithFullResponse ? response : response.body;
  };
}

const XMLHttpRequester = promisifyFn(_xhr.default);
XMLHttpRequester.del = promisifyFn(_xhr.default.del);
XMLHttpRequester.delete = XMLHttpRequester.del;
XMLHttpRequester.get = promisifyFn(_xhr.default.get);
XMLHttpRequester.head = promisifyFn(_xhr.default.head);
XMLHttpRequester.patch = promisifyFn(_xhr.default.patch);
XMLHttpRequester.post = promisifyFn(_xhr.default.post);
XMLHttpRequester.put = promisifyFn(_xhr.default.put);
var _default = XMLHttpRequester;
exports.default = _default;